<main
  class="min-h-screen bg-gray-50 py-8"
  appInfiniteScroll
  [threshold]="100"
  [disabled]="loading() || loadingMore() || !hasMoreIssues() || viewMode() !== 'list'"
  (scrolled)="onScroll()"
>
  <div class="max-w-7xl mx-auto px-4">
    <section class="mb-8">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Issue Tracker Dashboard</h1>
        <button
          type="button"
          (click)="createNewIssue()"
          class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition-colors duration-200 flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
          aria-label="Create new issue"
        >
          <i class="pi pi-plus" aria-hidden="true"></i>
          <span>Create New Issue</span>
        </button>
      </div>
    </section>

    <section class="mb-6">
      <form class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-end">
          <div class="lg:col-start-2">
            <label for="search-input" class="sr-only">Search issues by title</label>
            <app-search-input
              id="search-input"
              class="w-full"
              (searchChange)="onSearchChange($event)"
              [searchTerm]="searchTerm()"
              aria-label="Search issues by title"
            />
          </div>

          <div class="flex gap-3 justify-end">
            <button
              type="button"
              (click)="loadIssues()"
              class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors duration-200 flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
              aria-label="Refresh issues list"
            >
              <i class="pi pi-refresh" aria-hidden="true"></i>
              <span>Refresh</span>
            </button>
            <button
              type="button"
              (click)="isFilterOpen.set(!isFilterOpen())"
              [attr.aria-expanded]="isFilterOpen()"
              [attr.aria-controls]="'filter-panel'"
              class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors duration-200 flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
              aria-label="Toggle filter panel"
            >
              <i class="pi pi-filter" aria-hidden="true"></i>
              <span>Filter</span>
            </button>
          </div>
        </div>

        <div
          id="filter-panel"
          [class.hidden]="!isFilterOpen()"
          class="mt-4 pt-4 border-t border-gray-200"
          role="region"
          aria-labelledby="filter-heading"
        >
          <h2 id="filter-heading" class="sr-only">Filter options</h2>
          <app-issue-filtration
            class="w-full"
            (statusChange)="onStatusFilterChange($event)"
            [statuses]="statusFilter()"
            aria-label="Filter issues by status"
          />
        </div>
      </form>
    </section>

    <section class="p-4 bg-white rounded-md shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-800">Issues</h2>
        <div class="flex items-center gap-3">
          <fieldset class="flex bg-gray-100 rounded-lg p-1">
            <legend class="sr-only">Select view mode</legend>
            <button
              type="button"
              (click)="toggleViewMode()"
              [attr.aria-pressed]="viewMode() === 'list'"
              class="px-4 py-2 cursor-pointer text-sm font-medium rounded-md transition-all duration-200 flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 {{
                viewMode() === 'list'
                  ? 'bg-white text-blue-600 shadow-sm'
                  : 'text-gray-600 hover:text-gray-800'
              }}"
              aria-label="Switch to list view"
            >
              <i class="pi pi-list" aria-hidden="true"></i>
              <span>List</span>
            </button>
            <button
              type="button"
              (click)="toggleViewMode()"
              [attr.aria-pressed]="viewMode() === 'kanban'"
              class="px-4 py-2 cursor-pointer text-sm font-medium rounded-md transition-all duration-200 flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 {{
                viewMode() === 'kanban'
                  ? 'bg-white text-blue-600 shadow-sm'
                  : 'text-gray-600 hover:text-gray-800'
              }}"
              aria-label="Switch to kanban view"
            >
              <i class="pi pi-th-large" aria-hidden="true"></i>
              <span>Kanban</span>
            </button>
          </fieldset>
        </div>
      </div>
    </section>

    <section class="p-4 bg-gray-100 rounded-md">
      <div class="mb-4">
        <div class="flex items-center justify-between">
          <p class="text-gray-600" role="status" aria-live="polite">
            @if (searchTerm() && searchTerm().trim()) { @if (statusFilter().length > 0) { Showing
            {{ issues().length }} search results for "{{ searchTerm() }}" with statuses "{{
              statusFilter().join(', ')
            }}" } @else { Showing {{ issues().length }} search results for "{{ searchTerm() }}" } }
            @else if (statusFilter().length > 0) { Showing {{ issues().length }} issues with
            statuses "{{ statusFilter().join(', ') }}" } @else { Showing
            {{ issues().length }} issues }
          </p>
          @if ((searchTerm() && searchTerm().trim()) || statusFilter().length > 0) {
          <button
            type="button"
            (click)="clearFilters()"
            class="text-sm bg-gray-200 p-2 rounded-md hover:bg-gray-300 cursor-pointer text-gray-500 hover:text-gray-700 flex items-center gap-1 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
            aria-label="Clear all filters"
          >
            <i class="pi pi-times" aria-hidden="true"></i>
            <span>Clear filters</span>
          </button>
          }
        </div>
      </div>

      <!-- Loading State -->
      @if (loading()) {
      <div class="flex justify-center items-center py-8" role="status" aria-live="polite">
        <div
          class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"
          aria-hidden="true"
        ></div>
        <span class="ml-3 text-gray-600">Loading issues...</span>
      </div>
      }

      <!-- Error State -->
      @if (error()) {
      <div
        class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"
        role="alert"
      >
        <div class="flex items-center">
          <i class="pi pi-exclamation-triangle mr-2" aria-hidden="true"></i>
          <span>{{ error() }}</span>
        </div>
        <button
          class="mt-2 bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
          (click)="loadIssues()"
          aria-label="Try loading issues again"
        >
          Try Again
        </button>
      </div>
      }

      <!-- Issues Grid -->
      @if (!loading() && !error() && issues().length > 0) { @if (viewMode() === 'list') {
      <app-list [issues]="issues()" (issueDeleted)="onIssueDeleted($event)" />

      <!-- Infinite Scroll Loader -->
      @if (hasMoreIssues()) {
      <div class="mt-6 flex justify-center items-center py-4" role="status" aria-live="polite">
        @if (loadingMore()) {
        <div class="flex items-center gap-3">
          <div
            class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"
            aria-hidden="true"
          ></div>
          <span class="text-gray-600">Loading more issues...</span>
        </div>
        } @else {
        <div class="text-gray-500 text-sm">Scroll down to load more issues</div>
        }
      </div>
      } @else {
      <div class="mt-6 text-center py-4">
        <div class="text-gray-500 text-sm">
          <i class="pi pi-check-circle text-green-500 mr-2" aria-hidden="true"></i>
          <span>All issues loaded</span>
        </div>
      </div>
      } } @else {
      <app-kanban [issues]="issues()" (issueDeleted)="onIssueDeleted($event)" />
      } }

      <!-- Empty State -->
      @if (!loading() && !error() && issues().length === 0) {
      <div class="text-center py-8" role="status" aria-live="polite">
        <i class="pi pi-inbox text-4xl text-gray-400 mb-4" aria-hidden="true"></i>
        <h3 class="text-lg font-medium text-gray-600 mb-2">No issues found</h3>
        <p class="text-gray-500">There are no issues to display at the moment.</p>
      </div>
      }
    </section>
  </div>
</main>
